# Backtrader 对标项目（Vibe Coding）分阶段路线与完整功能清单

> 目标：通过大模型辅助编码，在“半天可交付可运行 MVP”的前提下，设计一条可持续扩展到平台级能力的路线。

## 1) 结论先行

- **半天完成“功能不少于 backtrader”不可行**：范围过大，含回测引擎、订单撮合、分析器、指标系统、可视化、实盘接入等。
- **半天完成“可运行且可扩展 MVP”可行**：先做最小内核并预留接口，后续迭代补齐能力。
- **推荐策略**：先交付一套“跑通 + 可验证 + 可扩展”的基础框架，再逐步叠加复杂能力。

---

## 2) 半天（4~6 小时）必须交付的最小版本（MVP）

### 2.1 核心交付（必须有）

1. **数据模型**
   - OHLCV K 线结构（时间、开高低收、成交量）
   - CSV 数据读取（单标的）
2. **策略协议**
   - `on_bar(bar, broker, state)` 回调
   - 至少 1 个示例策略（例如 MA 金叉死叉）
3. **撮合与账户**
   - 市价单（开盘或收盘成交，二选一且固定）
   - 现金、持仓、权益曲线计算
   - 手续费（固定费率）
4. **回测执行器**
   - 逐 bar 执行
   - 记录交易日志与权益曲线
5. **指标最小集**
   - SMA、EMA（至少 SMA）
6. **结果输出**
   - 总收益、最大回撤、胜率、交易次数
   - 输出到控制台 + JSON 文件

### 2.2 工程约束（必须有）

- 明确分层：`data / strategy / broker / engine / analyzers`
- 每层对外暴露接口，内部可替换
- 通过 1 条命令跑完整回测（例如 CLI）

### 2.3 半天内不做（刻意延后）

- 多标的组合、复杂订单（止损止盈/OCO/Bracket）
- 事件总线、异步撮合、实盘接入
- 高级分析器与可视化 UI

---

## 3) 完整功能清单（对标 backtrader 的产品级范围）

> 下列功能按“平台级能力”整理，可作为最终验收清单。

### A. 数据层

- [ ] CSV/Parquet/数据库读取
- [ ] 在线行情接入（REST + WebSocket）
- [ ] 多标的、多数据源统一时间轴
- [ ] 缺失值处理、复权、交易日历对齐
- [ ] 重采样（1m→5m/1h/1d）与回放
- [ ] 数据缓存与增量更新

### B. 策略层

- [ ] 策略生命周期（init/start/on_bar/on_order/on_trade/stop）
- [ ] 参数系统（网格/随机/贝叶斯优化可扩展）
- [ ] 多策略并行运行
- [ ] 组合级策略（资产配置、轮动、对冲）

### C. 指标层

- [ ] 内置指标库（MA、MACD、RSI、ATR、布林等）
- [ ] 指标依赖图与懒计算
- [ ] 自定义指标插件机制
- [ ] 第三方指标库接入（如 TA-Lib，可选）

### D. 交易与撮合层

- [ ] 订单类型：Market / Limit / Stop / StopLimit
- [ ] 扩展订单：Trailing / OCO / Bracket
- [ ] 部分成交、滑点模型、成交量约束
- [ ] 手续费与税费模型（按市场可配置）
- [ ] 保证金、杠杆、强平规则
- [ ] 资金管理（Sizer / Position Sizing）

### E. 组合与风控

- [ ] 多资产持仓簿（Portfolio）
- [ ] 风险预算（波动率目标、最大仓位、行业约束）
- [ ] 风控规则（止损、回撤熔断、限价保护）
- [ ] 交易前后风控钩子

### F. 分析与评估

- [ ] 收益与风险指标：CAGR、Sharpe、Sortino、Calmar
- [ ] 回撤分析、滚动绩效分析
- [ ] 交易明细统计（胜率、盈亏比、持仓时长）
- [ ] 基准对比与归因分析
- [ ] 结果导出（JSON/CSV/HTML 报告）

### G. 可视化与交互

- [ ] 权益曲线与回撤图
- [ ] K 线 + 买卖点 + 指标叠加
- [ ] 交互式参数看板
- [ ] 回测结果对比视图（多实验）

### H. 工程能力

- [ ] CLI 与配置系统（YAML/TOML）
- [ ] 插件机制（数据源/指标/策略/分析器）
- [ ] 日志、审计、可重复实验（seed + run metadata）
- [ ] 单元测试、回归测试、基准测试
- [ ] 文档与示例工程

### I. 生产化（高级阶段）

- [ ] 实盘网关（券商/交易所 API）
- [ ] 纸交易与实盘切换
- [ ] 监控告警（PnL、风险、连通性）
- [ ] 故障恢复与状态持久化

---

## 4) 分阶段实施计划（保证逐步增强）

## Phase 0（半天）：可运行 MVP

- 目标：单标的、单策略、单账户，输出基础绩效
- 验收：命令行一键执行，产出交易记录 + 绩效 JSON

## Phase 1（1~3 天）：研究可用

- 增加：多标的、更多订单类型、基础滑点模型
- 增加：参数批量回测（网格搜索）
- 验收：可对策略做批量实验并稳定复现

## Phase 2（3~7 天）：接近“框架”形态

- 增加：指标插件、分析器插件、报告模板
- 增加：更完整风控（仓位上限、回撤保护）
- 验收：可支撑 3~5 套策略并行评估

## Phase 3（1~2 周+）：平台化能力

- 增加：实盘/纸交易网关、监控与告警
- 增加：任务调度、实验管理
- 验收：具备小规模真实交易运行条件

---

## 5) 为 Vibe Coding 专门设计的执行方法

### 每阶段固定提示词模板（建议）

1. **架构提示词**：
   - “按 `data/strategy/broker/engine/analyzers` 分层生成代码，接口优先，不要把业务逻辑塞进脚本。”
2. **实现提示词**：
   - “先实现最小可运行版本，再补类型注解和测试，不要一次生成全部高级功能。”
3. **测试提示词**：
   - “为本次改动生成最小必要测试，至少覆盖：订单成交、权益计算、回撤计算。”
4. **重构提示词**：
   - “把重复逻辑提取为独立模块，保持公开接口不变。”

### 迭代纪律

- 一次只让模型做 1 个子模块
- 每次生成后立即运行测试
- 通过后再进入下一模块
- 失败时让模型只修错误，不重写全量文件

---

## 6) “半天完成”的现实目标定义

如果你坚持半天完成，建议把目标改成：

- **“半天完成可演示、可继续扩展的回测内核”**，而不是“全面超越 backtrader”。

半天内的成功标准：

- [ ] 可在本地跑通 1 个示例策略
- [ ] 结果指标可输出且可信
- [ ] 有基础测试（至少 3 个）
- [ ] 目录结构支持未来扩展

---

## 7) 推荐验收清单（每阶段都能量化）

- 功能覆盖率：本阶段 checklist 完成率 >= 90%
- 质量门槛：核心模块测试通过率 100%
- 性能门槛：固定数据集回测耗时可比较（记录基准）
- 可扩展门槛：新增一个指标/订单类型不改动既有核心接口

---

## 8) 一句话建议

- **可行，但要“先 MVP、后平台化”**。
- 用大模型做全量代码没问题，但要用“模块化 + 小步快跑 + 每步可验证”的节奏，否则会在复杂度上失控。
